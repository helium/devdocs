import vs_code_debug_view from '../images/device/vs_code_debug_view.png'
import vs_code_config_select from '../images/device/vs_code_config_select.png'
import device_packets from '../images/console/no_channel_packets.png'
import disco_board from '../images/device/disco_board.png'

# LongFi ST HAL Quickstart 

## Introduction

#### Helium’s LongFi protocol is a sub-GHz wireless protocol purpose-built for a wireless peer-to-peer network for low-bandwidth IoT applications.

This guide will show you step by step how to transmit LongFi packets using a longfi-st-hal example on an STMicroelectronics B-L072Z-LRWAN1 Discovery kit.

> ##### Important!  
> Before we begin, please make sure you've followed the steps from this [guide](/quickstart), which goes over some initial setup steps. 

To follow along, you'll need the following:
* Ubuntu 18.04 LTS (Any distro of linux should work, but we've only tested on this)
* <a href="https://www.st.com/en/evaluation-tools/b-l072z-lrwan1.html" target="_blank">STMicroelectronics B-L072Z-LRWAN1 Discovery kit</a>
* <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" target="_blank">GNU Arm Embedded Toolchain</a>  (Version 8-2019-q3-update)
* .<a href="https://github.com/ntfreak/openocd" target="_blank">OpenOCD</a> (Make sure this is added to your PATH, <a href="https://linuxize.com/post/how-to-add-directory-to-path-in-linux/" target="_blank">instructions</a>)
  * Run `./configure --enable-stlink` to install st-link support.
* <a href="https://code.visualstudio.com" target="_blank">Visual Studio Code</a>  
* <a href="https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug" target="_blank">Cortex Debug Extension</a>

## Hardware setup

The build for this project is easy! You’ll just need to install the included antenna.  
 
We'll be using the ST-Link debugger on the Discovery board, so you'll want to connect the micro-USB B connector to the micro-USB port labeled `CN7 USB STLINK`.

<img src={disco_board} /> 

That’s it for the hardware setup! 

## Compiling  

Let's start by cloning the `longfi-st-hal` repository.
```
git clone git@github.com:helium/longfi-st-hal.git
```
Next we'll navigate to the TransmitPacket example directory.
```
cd longfi-st-hal/Boards/B-L072Z-LRWAN1/Examples/TransmitPacket
```
### LongFi Config
In each example there is a `src/lf_radio.c` file, which contains the LongFi config needed to route packets to Helium Console, replace these default values with the values created for you in Console.
```c
uint8_t preshared_key[16] = {1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16};

LongFiConfig_t lf_config = {
    .oui = 1234,
    .device_id = 99,
    .auth_mode = PresharedKey128, 
};
```
Next we'll compile the firmware.
```
make
```
You should see something similar to the output below if all went well.
```
arm-none-eabi-size build/B-L072Z-LRWAN1-TransmitPacket.elf
   text    data     bss     dec     hex filename
  28220      60    3052   31332    7a64 build/B-L072Z-LRWAN1-TransmitPacket.elf
arm-none-eabi-objcopy -O ihex build/B-L072Z-LRWAN1-TransmitPacket.elf build/B-L072Z-LRWAN1-TransmitPacket.hex
arm-none-eabi-objcopy -O binary -S build/B-L072Z-LRWAN1-TransmitPacket.elf build/B-L072Z-LRWAN1-TransmitPacket.bin
```
## Debugging

Next, we'll use the Cortex Debug extension in VS code to debug our firmware example.  

If you are not familiar with VS code's debug view, checkout <a href="https://code.visualstudio.com/docs/editor/debugging" target="_blank">this</a> guide.  

If you installed Visual Studio Code via a package manager, then the following should open your current working directory.  

If not, then just launch VS code and use File->Open Folder.  
```
code .
```

First lets enter debug view by clicking the bug icon on the far left.  

Next, we'll click the gear icon to the right of the configuration dropdown to create a new config.

<img src={vs_code_debug_view} /> 

Then, select `Cortex Debug` from the dropdown.

<img src={vs_code_config_select} />

Replace the template with the following:

```
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Cortex Debug",
            "cwd": "${workspaceRoot}",
            "executable": "./build/B-L072Z-LRWAN1-TransmitPacket.elf",
            "request": "launch",
            "type": "cortex-debug",
            "servertype": "openocd",
            "device": "STM32L072CZ",
            "configFiles": [
                "interface/stlink-v2.cfg",
                "target/stm32l0.cfg"
            ]
        }
    ]
}
```
Now that we have configured our debug setup, lets start a debug session!  

Make sure that you have already compiled the firmware, steps above if you haven't.  

To start a debug session, make sure you have your `Cortex Debug` config selected and click the play icon. After a few seconds, your firmware should be loaded on the board and paused in the reset handler.

You are now debugging!

Let's head back to [Helium Console](https://console.helium.com) and look at our device. 

You should be able to see some packets appear as Live Data. 

<img src={device_packets} />

* To learn about routing these packets to an endpoint, check out this [guide] (/console/routing-data). 
 

