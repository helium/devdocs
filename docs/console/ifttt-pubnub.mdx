import pubnub_register from '../images/pubnub/pubnub_register.png'
import pubnub_createnewapp from '../images/pubnub/pubnub_createnewapp.png'
import pubnub_decode_email from '../images/pubnub/pubnub_decode_email.png'
import pubnub_create_module_email from '../images/pubnub/pubnub_create_module_email.png'
import pubnub_create_new_function_email from '../images/pubnub/pubnub_create_new_function_email.png'
import pubnub_create_new_function_add_code_email from '../images/pubnub/pubnub_create_new_function_add_code_email.png'
import pubnub_module_running_email_2 from '../images/pubnub/pubnub_module_running_email_2.png'

import pubnub_console from '../images/pubnub/pubnub_console.png'
import pubnub_module_restart_module from '../images/pubnub/pubnub_module_restart_module.png'
import ifttt_getting_started from '../images/pubnub/ifttt_getting_started.png'
import ifttt_getting_started_2 from '../images/pubnub/ifttt_getting_started_2.png'
import ifttt_choose_service from '../images/pubnub/ifttt_choose_service.png'
import ifttt_choose_trigger from '../images/pubnub/ifttt_choose_trigger.png'
import ifttt_complete_trigger from '../images/pubnub/ifttt_complete_trigger.png'
import ifttt_action_start from '../images/pubnub/ifttt_action_start.png'
import ifttt_action_choose from '../images/pubnub/ifttt_action_choose.png'
import ifttt_action_choose_2 from '../images/pubnub/ifttt_action_choose_2.png'
import ifttt_action_complete from '../images/pubnub/ifttt_action_complete.png'
import ifttt_action_review from '../images/pubnub/ifttt_action_review.png'
import ifttt_webhooks from '../images/pubnub/ifttt_webhooks.png'
import ifttt_webhooks_key from '../images/pubnub/ifttt_webhooks_key.png'
import pubnub_webhooks_url_email from '../images/pubnub/pubnub_webhooks_url_email.png'


# Triggering services with device data

This guide will show you how to route your device data from Console to a serverless function service that will allow you to decode the base64 encoding that the packet payload is encoded with and then trigger a simple service on IFTTT with the payload.

> #### IMPORTANT:  
If you haven’t completed the Console and device quickstart instructions, please perform those [here](https://developer.helium.com/quickstart) before continuing with this guide.

This guide will show you how to perform the following:

* Create and configure a PubNub Function to decode a base64 payload from your device.
* Add the PubNub Function endpoint as an HTTP channel in Console.
* Create and configure an IFTTT Applet to send an email with the payload.
* Update the PubNub Function with the IFTTT Webhook endpoint address.

## Creating PubNub Function

First you will need to [register](https://dashboard.pubnub.com/signup) for a free PubNub account. No credit card required!

<img src={pubnub_register} />

Next [login](https://dashboard.pubnub.com/login) to the PubNub dashboard.

Choose **Other Messaging Use Cases** and click **START USING PUBNUB**.

Navigate to the Apps page on the left menu.

Click **CREATE NEW APP**, name it `DecodeAndForward`, and finally select **Other Messaging Use Cases**.

<img src={pubnub_createnewapp} />

Your app should appear:

<img src={pubnub_decode_email} />

Next on the left-hand menu click **Functions**, and make sure the `DecodeAndForward` app is selected.

Click **CREATE NEW MODULE** to create a new module and enter the following name `decode_and_forward`.

<img src={pubnub_create_module_email} />

Next create a function by clicking the **decode_and_forward** module.

Click **CREATE FUNCTION** and fill in the fields with the following:

* Function name: `decode64_and_forward`
* Event type: `On Request`
* URI path: `decode`

Click **CREATE**.

<img src={pubnub_create_new_function_email} />

You will be dropped into the Function editor with a default Javascript request function:

<img src={pubnub_create_new_function_add_code_email} />

Replace the entire function with the provided code below:

	export default (request, response) => {
		const pubnub = require('pubnub');
		const xhr = require('xhr');
    	const base64Codec = require('codec/base64');

    	let headersObject = request.headers;
    	let paramsObject = request.params;
    	let methodString = request.method;
    	let bodyString = request.body;
    
    	// parse request body json
    	let bodyJson = JSON.parse(request.body);
    	console.log(bodyJson);
    
    	// decode longfi payload and parse string into json
    	let parsedJsonPayload = JSON.parse(base64Codec.atob(bodyJson.payload));
    	// log parsed json payload
    	// console.log(parsedJsonPayload);
    
    	// POST parsed json payload to IFTTT webhook service
    	xhr.fetch('PLACEHOLDER', {
    	    'method': 'POST',
     	   'body' : parsedJsonPayload
     	   }).then(() => {
    	    console.log("Packet sent with payload: " + JSON.stringify(parsedJsonPayload));
    	}).catch((err) => {
    	    console.log(err);
    	});

    	// Set the status code - by default it would return 200
    	response.status = 200;
    	// Set the headers the way you like
    	response.headers['X-Custom-Header'] = 'CustomHeaderValue';

    	return request.json().then((body) => {
    	    return response.send("OK");
    	}).catch((err) => {
     	   console.log(err)
     	   return response.send("Malformed JSN body.");
    	});
	};

<img src={pubnub_module_running_email_2} />

This simple function allows us to take the payload field of the packet coming from Console, perform a base64 decode operation, and then forward it to any desired HTTP endpoint.

After replacing the code, click **SAVE**, and then Click **Start Module**. 

[If you receive “ERROR: Missing required fields: code”, completely remove the code and re-paste it. Then click **SAVE**].

Before leaving this dashboard, copy the Function’s endpoint URL by clicking **COPY URL** on the left panel in the Path entry box. 

Save that URL in a text editor, you'll need it later.

## Creating Console HTTP Channel with PubNub Function Endpoint

Next in another tab open the Helium [Console](https://console.helium.com), and navigate to the Channels section. 

Click the HTTP icon to create an HTTP channel. Then copy the PubNub Function endpoint URL into the Endpoint field, and select POST from the drop down. 

Name your channel `pubnub_decode_forward`.

<img src={pubnub_console} />

Return to the previous PubNub Function editor window. 

If you haven’t plugged in your transmitting device from the device quickstart do so now. 

You should see error messages in the PubNub console window located at the bottom of the editor view. 

If you are not seeing anything, restart the Function by clicking **Restart module** at the top right of the window.

<img src={pubnub_module_restart_module} />

Let’s unplug the transmitting device to avoid exhausting the maximum transactions allowed with the free plan, although it's 1,000,000.

## Creating IFTTT Applet to email packet payload

First [create](https://ifttt.com/join) a free IFTTT account if you don’t already have one and sign in. 

<img src={ifttt_getting_started} />

Next visit https://ifttt.com/create to create an applet.

<img src={ifttt_getting_started_2} />

Click the large plus button after If to select a triggering service. Search for `Webhooks` and select the service by clicking the box seen below.

<img src={ifttt_choose_service} />

Next select the only trigger action this service provides, seen below. Click the **Receive a web request** box.

<img src={ifttt_choose_trigger} />

Let’s name this `forward_packet_email`, and click **Create trigger**.

<img src={ifttt_complete_trigger} />

Great, you’ve added the service that will receive the payload packet from our PubNub Function, we’ll configure that soon, but first let's pick the action, or what happens when the trigger is activated.

<img src={ifttt_action_start} />

At this point you could pick any one of thousands of actions like sending a tweet, text, or even turning on a smart light bulb, but for simplicity we will use the email service to send a simple email with the payload each time a packet is forwarded.

<img src={ifttt_action_choose} />

Enter your email address and the pin sent to that address.

Select the single action offered from this service:

<img src={ifttt_action_choose_2} />

Next use the default field configuration and click **Create action**.

<img src={ifttt_action_complete} />

Finally click **Finish**.

<img src={ifttt_action_review} />

Navigate to the Webhooks service page and click **Documentation** at the top right:

<img src={ifttt_webhooks} />

On this page type in the name chosen for the webhook event name, `forward_packet_email`. Go ahead and type that into the box with ‘{event}’. 

Next copy the webhook endpoint URL at the bottom, this is what our PubNub Function will be making an HTTP Post request to.

<img src={ifttt_webhooks_key} />

## Update PubNub Function POST URL

Ok, almost done! Return to our PubNub Function editor window now.
As our last step, replace the `PLACEHOLDER` string with our IFTTT Webhook URL at line 21 in the function.

<img src={pubnub_webhooks_url_email} />

Next, click **Save** and then the **Restart module**. 

Congratulations! You've configured the entire pipeline, click **CLEAR** in the bottom console and then plug our device back in to begin transmitting again. 

You should no longer see errors in the Console and should receive emails from IFTTT. Congrats!



