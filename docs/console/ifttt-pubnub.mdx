import pubnub_register from '../images/pubnub/pubnub_register.png'
import pubnub_createnewapp from '../images/pubnub/pubnub_createnewapp.png'
import pubnub_decode_email from '../images/pubnub/pubnub_decode_email.png'
import pubnub_create_module_email from '../images/pubnub/pubnub_create_module_email.png'
import pubnub_create_new_function_email from '../images/pubnub/pubnub_create_new_function_email.png'
import pubnub_create_new_function_add_code_email from '../images/pubnub/pubnub_create_new_function_add_code_email.png'
import pubnub_module_running_email_2 from '../images/pubnub/pubnub_module_running_email_2.png'

# Triggering IFTTT services with device data

This guide will show you how to route your device data from console to a serverless function service that will allow you to decode the base64 encoding that the packet payload is encoded with and then trigger a simple service on IFTTT with the payload.

> #### IMPORTANT:  
If you haven’t completed the Console and device quickstart instructions, please perform those before following this [guide](https://developer.helium.com/quickstart).

This guide will show you how to perform the following:

* Create and configure a PubNub Function to decode a base64 payload from your device.
* Add the PubNub Function endpoint as an HTTP channel in Console.
* Create and configure an IFTTT Applet to send an email with the payload.
* Update the PubNub Function with the IFTTT Webhook endpoint address.

## Creating PubNub Function

First you will need to [register](https://dashboard.pubnub.com/signup) for a free PubNub account. No credit card required!

<img src={pubnub_register} />

Next [login](https://dashboard.pubnub.com/login) to the PubNub dashboard.

Choose Other Messaging Use Cases and click START USING PUBNUB.

Navigate to the Apps page on the left menu.

Click CREATE NEW APP, name it “DecodeAndForward, and finally select ‘Other messaging Use Cases’.

<img src={pubnub_createnewapp} />

Your app should appear:

<img src={pubnub_decode_email} />

Next on the left-hand menu click Functions, make sure the DecodeAndForward app is selected.

Click ‘Create New Module’ to create a new module and enter the following name “decode_and_forward”.

<img src={pubnub_create_module_email} />

Next let’s create a function by clicking the decode_and_forward module.

Click CREATE FUNCTION and fill in the fields with the following:

Function name: decode64_and_forward
Event type: On Request
URI path: decode

Click CREATE.

<img src={pubnub_create_new_function_email} />

You will be dropped into the Function editor with a default Javascript request function:

<img src={pubnub_create_new_function_add_code_email} />

Replace the entire function with the provided code below:

	export default (request, response) => {
		const pubnub = require('pubnub');
		const xhr = require('xhr');
    	const base64Codec = require('codec/base64');

    	let headersObject = request.headers;
    	let paramsObject = request.params;
    	let methodString = request.method;
    	let bodyString = request.body;
    
    	// parse request body json
    	let bodyJson = JSON.parse(request.body);
    	console.log(bodyJson);
    
    	// decode longfi payload and parse string into json
    	let parsedJsonPayload = JSON.parse(base64Codec.atob(bodyJson.payload));
    	// log parsed json payload
    	// console.log(parsedJsonPayload);
    
    	// POST parsed json payload to IFTTT webhook service
    	xhr.fetch('PLACEHOLDER', {
    	    'method': 'POST',
     	   'body' : parsedJsonPayload
     	   }).then(() => {
    	    console.log("Packet sent with payload: " + JSON.stringify(parsedJsonPayload));
    	}).catch((err) => {
    	    console.log(err);
    	});

    	// Set the status code - by default it would return 200
    	response.status = 200;
    	// Set the headers the way you like
    	response.headers['X-Custom-Header'] = 'CustomHeaderValue';

    	return request.json().then((body) => {
    	    return response.send("OK");
    	}).catch((err) => {
     	   console.log(err)
     	   return response.send("Malformed JSN body.");
    	});
	};

<img src={pubnub_module_running_email_2} />

This simple function will allow us to take the payload field of the packet coming from Console, perform a base64 decode operation, and then forward that to any http endpoint we’d like.

After you have replaced the code, click SAVE and then Click Start Module. 

[If you receive “ERROR: Missing required fields: code”, completely remove the code and re-paste it. Then click SAVE].

Now before we leave this dashboard temporarily, copy the Function’s endpoint URL by clicking COPY URL on the left panel in the Path entry box. 

Save that URL in a text editor, we’ll need it in a few minutes.

## Creating Console HTTP Channel with PubNub Function Endpoint



